# Техническое задание: Редактор Диалогов Dialog Craft

## 1. Общее описание

**Название проекта:** Dialog Craft
**Цель:** Разработка desktop-приложения для визуального создания и редактирования диалоговых систем, предназначенного для геймдизайнеров. Приложение должно обеспечивать удобное построение сложных диалоговых деревьев с автоматическим расположением узлов по иерархии.
**Платформа:** Desktop-приложение на базе Electron, работающее в офлайн-режиме.
**Основной пользователь:** Геймдизайнер
**Роли доступа:** Не предусмотрены.

---

## 2. Функциональные требования

### 2.1. Управление карточками

#### 2.1.1. Типы карточек

Редактор должен поддерживать следующие типы карточек:

- **Реплика:** Стандартная карточка с текстом реплики.

#### 2.1.2. Атрибуты и свойства карточек

Каждая карточка должна содержать следующие параметры:

- **Название реплики:** Краткое описание или заголовок карточки.
- **ID:** Уникальный идентификатор карточки.
- **Тип реплики:** Определяет тип карточки (реплика).
- **Текст:** Содержание реплики.
- **Background:** Путь к файлу фонового изображения.
- **Portrait:** Путь к файлу изображения персонажа.
- **character_name:** Имя персонажа, произносящего реплику.
- **introduce_character:** Флаг или поле для ввода данных о появлении нового персонажа.
- **pause:** Параметр для задания задержки/паузы после реплики.
- **is_narrator:** Булевый параметр, указывающий, что реплика произносится рассказчиком.
- **is_thought:** Булевый параметр, обозначающий, что реплика является внутренним монологом или мыслью.

Необходимо предусмотреть возможность добавления новых параметров в будущем. Модульная архитектура приложения должна позволить добавлять новые параметры без критических изменений в основной структуре. Внешний вид карточки при этом меняться не должен, но в меню редактирования справа должно появиться место для редактирования новых параметров по аналогии с существующими. Интерфейс редактирования параметров должен быть удобным, например: чекбоксы для булевых параметров, текстовые поля ввода для текста, диалог выбора файла для изображений.

#### 2.1.3. Операции с карточками

- **Создание карточек:**
  - Добавление новых карточек с автоматическим присвоением уникального ID (порядковый номер: 1, 2, 3 и т.д.).
  - Вставка новой карточки в существующую связь между двумя карточками.
- **Редактирование карточек:**
  - Изменение любых параметров карточки.
  - Добавление и удаление дополнительных параметров.
  - Отдельная кнопка для редактирования ID с возможностью использовать существующий ID. При этом, если такой ID уже существует, необходимо увеличить ID существующей карточки и всех последующих на единицу для обеспечения уникальности.
- **Удаление карточек:**
  - Удаление выбранной карточки с автоматическим обновлением связей связанных карточек.
  - Подтверждение операции удаления.

---

### 2.2. Управление связями

- **Создание связей:**

  - Установление связей между карточками для формирования диалогового дерева.
  - Для визуализации связей и автоматической расстановки используется **Cytoscape.js** и **Dagre**.
  - Каждая связь имеет свой тип, который визуально отображается цветом линии связи.

- **Визуальное отображение:**
  - Автоматическая расстановка карточек при импорте: корневые карточки сверху, дочерние ниже.
  - Поддержка drag-and-drop для изменения расположения карточек и связей с динамической перерисовкой связей.

---

### 2.3. Работа с файлами

#### 2.3.1. Экспорт и импорт

- **Экспорт:**
  - Экспорт диалогов в формате YAML.
  - Сохранение данных в формате, обеспечивающем корректное чтение и импорт.
  - Сортировка карточек по ID при экспорте.
- **Импорт:**
  - Импорт диалогов из YAML-файлов с автоматическим расположением карточек (корневые сверху, дочерние ниже).
  - Модуль импорта/экспорта должен быть спроектирован с возможностью добавления поддержки других форматов (JSON, XML) в будущем.

#### 2.3.2. Сохранение текущего прогресса работы

- **Автосохранение:**
  - Автоматическое сохранение прогресса в формате, оптимальном для внутреннего использования, каждые несколько минут.
  - Создание файла автосохранения с названием сцены и временной меткой.
  - Хранение 3-5 последних копий автосохранений для быстрого восстановления.

---

### 2.4. Пользовательский интерфейс (UI/UX) и рабочее пространство

#### 2.4.1. Визуальный стиль и взаимодействие с рабочим пространством

- **Рабочее пространство:**

  - Реализовано в виде бесконечного холста с возможностью свободного перемещения и масштабирования.
  - Поддержка drag-and-drop для перемещения карточек с динамической перерисовкой связей, избегая пересечений.
  - При сохранении сцены фиксируется логика диалога и расположение элементов на холсте.

- **Визуализация карточек:**

  Код с примером визуализации карточек находится в файле ui_example.js

- **Создание новых элементов:**

  - В интерфейсе рабочего пространства добавить иконку плюса в кружочке (например, в левом верхнем углу или на панели инструментов).

- **Создание связей между карточками:**
  - Для начала создания связи пользователь нажимает на круг с плюсом расположенном на нижней границе карточки с правой стороны, после чего появляется линия связи, которая динамически следует за курсором.
  - Линия связи динамически следует за курсором до клика на целевой карточке и фиксируется в верхней точке подключения.
  - При клике на линию связи в области редактирования справа появляется панель с параметрами этого критерия, где можно отредактировать его название (label) и тип, что влияет на цвет линии и круга в родительской карточке.
  - Несколько кругов перехода на одной карточке располагаются по горизонтали на нижней границе карточки.

#### 2.4.2. Редактирование параметров карточек

- При нажатии на карточку с правой стороны появляется панель для редактирования её параметров (см. раздел 2.1.2. Атрибуты и свойства карточек).

#### 2.4.3. Обработка ошибок и уведомления

- **Кнопка "Логи":** Добавить кнопку (значок уведомления). При нажатии отображается окно с отформатированным сообщением об ошибке и указанием на файл с полным трейсом ошибки.
- Предусмотреть возможность очистки всего списка ошибок или удаления отдельной ошибки.

---

## 3. Технические особенности и архитектура

### 3.1. Модульная архитектура

- Приложение должно иметь модульную архитектуру.
- Каждый компонент интерфейса реализован в отдельном файле или модуле.
- Необходимо придерживаться единого стиля разработки.
- Отдельный модуль для импорта/экспорта файлов.
- Карточки должны быть реализованы как отдельные модули, что позволит легко добавлять новые параметры в будущем.

### 3.2. Используемые технологии

- **Язык программирования:** JavaScript
- **Библиотеки и фреймворки:** Electron, React, TypeScript, Cytoscape.js, Dagre.
- **Операционные системы:** Windows 10 и macOS.

### 3.3. Обновления и логирование ошибок

- Обновление приложения осуществляется полной заменой.
- **Логирование ошибок:** Сохранение информации об ошибках в специальную директорию. Предоставить пользователю возможность отправки логов разработчикам.

---

## 4. Нефункциональные требования

- **Производительность:**
  - Обработка до 1000 карточек и связанных диаграмм с приемлемым временем отклика.
  - Допустимая задержка при работе с максимально загруженными диаграммами.
- **Надежность:**
  - Автосохранение с ротацией копий.
  - Обработка ошибок с информативными сообщениями.
- **Безопасность:**
  - Проверка входных данных.
  - Подтверждение критических операций (удаление карточек).
  - Работа в офлайн-режиме, взаимодействие только через импорт/экспорт.
- **Поддержка и обновление:**
  - Логирование ошибок с возможностью экспорта логов.
  - Простота обновления за счет полной замены приложения.

---

## 5. Документация и поддержка

- **Для разработчиков:**
  - Документация к коду с комментариями и описанием модулей.
  - Логирование ошибок и обратная связь от пользователей для отладки.

---

## 6. Ограничения и допущения

- Ориентация на геймдизайнеров.
- Отсутствие разделения на роли и уровней доступа.
- Обновление путем полной замены приложения.
- Поддержка только Windows 10 и macOS.
